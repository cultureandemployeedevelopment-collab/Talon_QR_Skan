<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>GHG Yem…ôk Skaner</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f0f2f5;min-height:100vh}
    .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:15px;text-align:center}
    .header h1{font-size:1.3em}
    .container{max-width:600px;margin:0 auto;padding:15px}
    .scanner-box{background:#fff;border-radius:20px;padding:15px;margin-bottom:15px;box-shadow:0 4px 15px rgba(0,0,0,.1)}
    #reader{width:100%;border-radius:16px;overflow:hidden}
    .status{text-align:center;padding:12px;margin-top:10px;border-radius:12px;font-weight:600;font-size:.95em}
    .status-waiting{background:#fff3e0;color:#e65100}
    .status-scanning{background:#e3f2fd;color:#1565c0}
    .status-success{background:#e8f5e9;color:#2e7d32}
    .status-warning{background:#fff3e0;color:#f57c00}
    .status-error{background:#ffebee;color:#c62828}

    .result-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1000;justify-content:center;align-items:center;padding:20px}
    .result-card{background:#fff;border-radius:24px;padding:26px;width:100%;max-width:420px;text-align:center}
    .result-icon{width:90px;height:90px;border-radius:50%;margin:0 auto 18px;display:flex;align-items:center;justify-content:center;font-size:46px}
    .result-success .result-icon{background:#e8f5e9;color:#4caf50}
    .result-warning .result-icon{background:#fff3e0;color:#ff9800}
    .result-error .result-icon{background:#ffebee;color:#f44336}
    .result-title{font-size:1.3em;font-weight:800;margin-bottom:14px}
    .result-details{background:#f5f5f5;border-radius:16px;padding:16px;margin-bottom:14px;text-align:left}
    .detail-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e0e0e0}
    .detail-row:last-child{border-bottom:none}
    .detail-label{color:#666;font-size:.9em}
    .detail-value{color:#333;font-weight:700;font-size:.95em}

    .btn{border:none;border-radius:14px;padding:12px 14px;font-weight:800;cursor:pointer;width:100%}
    .btn-confirm{background:#4caf50;color:#fff;margin-top:10px}
    .btn-close{background:#e0e0e0;color:#111;margin-top:10px}

    .countdown{font-size:2.2em;font-weight:800;color:#667eea;margin-top:10px}
    .countdown-text{color:#999;font-size:.9em;margin-top:5px}

    .last-scan{background:#fff;border-radius:20px;padding:20px;box-shadow:0 4px 15px rgba(0,0,0,.1)}
    .last-scan h2{font-size:1.1em;color:#333;margin-bottom:15px}
    .scan-item{display:flex;align-items:center;padding:12px;border-bottom:1px solid #eee}
    .scan-item:last-child{border-bottom:none}
    .scan-icon{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;margin-right:12px;flex-shrink:0}
    .scan-icon.ok{background:#e8f5e9;color:#4caf50}
    .scan-icon.warn{background:#fff3e0;color:#ff9800}
    .scan-icon.err{background:#ffebee;color:#f44336}
    .scan-info{flex:1;min-width:0}
    .scan-name{font-weight:700;color:#333;font-size:.95em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .scan-detail{color:#666;font-size:.8em;margin-top:2px}
    .scan-time{color:#999;font-size:.75em;margin-top:2px}
  </style>
</head>
<body>
  <div class="header"><h1>üçΩÔ∏è GHG Yem…ôk Skaner</h1></div>

  <div class="container">
    <div class="scanner-box">
      <div id="reader"></div>
      <div class="status status-waiting" id="status">QR kod g√∂zl…ônilir...</div>
    </div>

    <div class="last-scan">
      <h2>üìã Son skan edil…ônl…ôr</h2>
      <div id="scanList">
        <div style="text-align:center;color:#999;padding:20px;">H…ôl…ô he√ß bir skan edilm…ôyib</div>
      </div>
    </div>
  </div>

  <div class="result-overlay" id="resultOverlay">
    <div class="result-card" id="resultCard">
      <div class="result-icon" id="resultIcon">‚úì</div>
      <div class="result-title" id="resultTitle">T…ôsdiql…ôndi</div>

      <div class="result-details">
        <div class="detail-row"><span class="detail-label">∆èm…ôkda≈ü:</span><span class="detail-value" id="detailName">-</span></div>
        <div class="detail-row"><span class="detail-label">ID:</span><span class="detail-value" id="detailId">-</span></div>
        <div class="detail-row"><span class="detail-label">Talon:</span><span class="detail-value" id="detailTicket">-</span></div>
        <div class="detail-row"><span class="detail-label">Status:</span><span class="detail-value" id="detailStatus">-</span></div>
      </div>

      <button class="btn btn-confirm" id="confirmBtn" style="display:none;">‚úÖ T…ôsdiq et</button>
      <button class="btn btn-close" id="closeBtn">Baƒüla</button>

      <div class="countdown" id="countdown" style="display:none;">5</div>
      <div class="countdown-text" id="countdownText" style="display:none;">saniy…ô sonra skaner…ô qayƒ±dƒ±lƒ±r</div>
    </div>
  </div>

  <script>
    const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbzWxSTDHVUEFHtUbS_fiyk-xXoJX92LQPtYkAez5M89tkp696HlhkCetgxS41waHoR0/exec';

    // ne√ß…ô saniy…ôy…ô overlay baƒülansƒ±n
    const COUNTDOWN_SECONDS = 5;

    // eyni QR ardƒ±cƒ±l oxunanda (kamera ‚Äútitr…ôm…ôsi‚Äù) filter
    const LAST_QR_COOLDOWN_MS = 900;

    // QURU QAYDA (s…ônin dediyin):
    // 1-ci scan -> normal scanTicket (sheet…ô d√º≈ü√ºr)
    // 2-ci scan -> ‚ÄúT…ôsdiq et‚Äù d√ºym…ôsi √ßƒ±xƒ±r (h…ôl…ô sheet…ô T…ôsdiq d√º≈üm…ôy…ôc…ôk)
    // D√ºym…ôy…ô bas -> confirmDrySecond √ßaƒürƒ±lƒ±r v…ô SHEET-…ô "T…ôsdiq" d√º≈üm…ôlidir
    // 3-c√º scan -> scanTicket yen…ô √ßaƒürƒ±lƒ±r v…ô "T…ôkrar c…ôhd" (sheet…ô d…ô d√º≈ü√ºr)
    const DRY_TTL_MS = 24 * 60 * 60 * 1000;

    let isProcessing = false;
    let scanHistory = [];
    let html5QrCode = null;
    let countdownInterval = null;

    // confirm state
    let pendingConfirmToken = null;
    let pendingConfirmQrData = null;
    let pendingConfirmMeta = null;

    // dedup
    let lastQrText = '';
    let lastQrAt = 0;

    // quru sayƒüacƒ±
    const dryCountMap = new Map(); // qrData -> {count, ts}

    function isDryQR(qrData){
      // format: GHG|empId|Q|dd.mm.yyyy|hash|dry
      const parts = String(qrData || '').split('|');
      const code = parts[2];  // Q
      const last = parts[5];  // dry
      return code === 'Q' || last === 'dry' || String(qrData).includes('|Q|') || String(qrData).includes('|dry');
    }

    function getDryCount(qrData){
      const row = dryCountMap.get(qrData);
      if (!row) return 0;
      if (Date.now() - row.ts > DRY_TTL_MS){ dryCountMap.delete(qrData); return 0; }
      return row.count || 0;
    }
    function setDryCount(qrData, count){
      if (!qrData) return;
      dryCountMap.set(qrData, {count, ts: Date.now()});
    }

    // ‚úÖ JSONP daha stabil: timeout clear + cleanup
    function fetchJSONP(url, {timeoutMs=12000, retry=1} = {}) {
      return new Promise((resolve, reject) => {
        const cb = 'cb_' + Date.now() + '_' + Math.floor(Math.random()*1000);
        const script = document.createElement('script');
        script.async = true;

        let timer = null;
        let finished = false;

        function cleanup(){
          if (timer) clearTimeout(timer);
          timer = null;
          try{ if (window[cb]) delete window[cb]; }catch(e){}
          try{ if (script && script.parentNode) script.parentNode.removeChild(script); }catch(e){}
        }

        function fail(err){
          if (finished) return;
          finished = true;
          cleanup();
          if (retry > 0) {
            return resolve(fetchJSONP(url, {timeoutMs, retry: retry-1}));
          }
          reject(err);
        }

        window[cb] = (data) => {
          if (finished) return;
          finished = true;
          cleanup();
          resolve(data);
        };

        timer = setTimeout(() => fail(new Error('Timeout')), timeoutMs);

        script.onerror = () => fail(new Error('Load error'));

        // ‚úÖ cache qƒ±rmaq √º√ß√ºn t parametri …ôlav…ô edirik
        const nonce = Date.now();
        script.src = url
          + (url.includes('?') ? '&' : '?')
          + 'callback=' + cb
          + '&t=' + nonce;

        document.head.appendChild(script);
      });
    }

    function updateStatus(type, text){
      const s = document.getElementById('status');
      s.className = 'status status-' + type;
      s.textContent = text;
    }

    function addScan(item){
      const time = new Date().toLocaleTimeString('az-AZ');
      scanHistory.unshift({...item, time});
      if (scanHistory.length > 10) scanHistory.pop();

      const list = document.getElementById('scanList');
      list.innerHTML = scanHistory.map(scan=>{
        let icon='‚úì', cls='ok';
        if (scan.err) { icon='‚úï'; cls='err'; }
        else if (scan.warn) { icon='‚ö†'; cls='warn'; }

        return `
          <div class="scan-item">
            <div class="scan-icon ${cls}">${icon}</div>
            <div class="scan-info">
              <div class="scan-name">${scan.name}</div>
              <div class="scan-detail">${scan.id} ${scan.type ? '| ' + scan.type : ''} | ${scan.msg}</div>
              <div class="scan-time">${scan.time}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function startCountdown(){
      if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }

      const countdownEl = document.getElementById('countdown');
      const countdownText = document.getElementById('countdownText');

      countdownEl.style.display = 'block';
      countdownText.style.display = 'block';

      let seconds = COUNTDOWN_SECONDS;
      countdownEl.textContent = seconds;

      countdownInterval = setInterval(()=>{
        seconds--;
        countdownEl.textContent = seconds;
        if (seconds <= 0){
          clearInterval(countdownInterval);
          countdownInterval = null;
          hideResult();
        }
      }, 1000);
    }

    function showResult({resultType, name, id, type, statusText, mode='auto', confirmToken=null}){
      // mode: 'auto' (countdown) | 'confirm' (d√ºym…ôli) | 'confirmInfo' (d√ºym…ôsiz confirm info)

      document.getElementById('countdown').textContent = COUNTDOWN_SECONDS;

      const overlay = document.getElementById('resultOverlay');
      const card = document.getElementById('resultCard');
      const icon = document.getElementById('resultIcon');
      const title = document.getElementById('resultTitle');

      document.getElementById('detailName').textContent = name || '-';
      document.getElementById('detailId').textContent = id || '-';
      document.getElementById('detailTicket').textContent = type || '-';
      document.getElementById('detailStatus').textContent = statusText || '-';

      card.className = 'result-card result-' + resultType;

      const confirmBtn = document.getElementById('confirmBtn');
      const closeBtn = document.getElementById('closeBtn');

      pendingConfirmToken = confirmToken || null;

      // reset
      confirmBtn.style.display = 'none';
      confirmBtn.disabled = false;
      confirmBtn.textContent = '‚úÖ T…ôsdiq et';

      closeBtn.disabled = false;
      closeBtn.style.opacity = '1';
      closeBtn.style.cursor = 'pointer';

      // countdown default gizl…ôt
      document.getElementById('countdown').style.display='none';
      document.getElementById('countdownText').style.display='none';
      if (countdownInterval){ clearInterval(countdownInterval); countdownInterval = null; }

      if (resultType === 'success'){
        icon.textContent='‚úì'; title.textContent='T…ôsdiql…ôndi';
        closeBtn.disabled = true; closeBtn.style.opacity = '.6'; closeBtn.style.cursor = 'not-allowed';
        if (mode === 'auto') startCountdown();
      } else if (resultType === 'warning'){
        icon.textContent='‚ö†'; title.textContent='X…ôb…ôrdarlƒ±q';
        closeBtn.disabled = true; closeBtn.style.opacity = '.6'; closeBtn.style.cursor = 'not-allowed';
        if (mode === 'auto') startCountdown();
      } else if (resultType === 'confirm'){
        icon.textContent='?'; title.textContent='T…ôsdiql…ôndi';
        if (mode === 'confirm') {
          confirmBtn.style.display = 'block';
        } else {
          // confirmInfo: d√ºym…ôsiz
          confirmBtn.style.display = 'none';
        }
      } else {
        icon.textContent='‚úï'; title.textContent='X…ôta';
        closeBtn.disabled = true; closeBtn.style.opacity = '.6'; closeBtn.style.cursor = 'not-allowed';
        if (mode === 'auto') startCountdown();
      }

      overlay.style.display='flex';
    }

    function hideResult(){
      document.getElementById('resultOverlay').style.display='none';
      isProcessing = false;

      pendingConfirmToken = null;
      pendingConfirmQrData = null;
      pendingConfirmMeta = null;

      document.getElementById('countdown').style.display='none';
      document.getElementById('countdownText').style.display='none';
      if (countdownInterval){ clearInterval(countdownInterval); countdownInterval = null; }

      updateStatus('waiting','QR kod g√∂zl…ônilir...');
    }

    function shouldDropDuplicate(qrText){
      const now = Date.now();
      if (qrText === lastQrText && (now - lastQrAt) < LAST_QR_COOLDOWN_MS) return true;
      lastQrText = qrText;
      lastQrAt = now;
      return false;
    }

    async function handleScan(qrData){
      if (shouldDropDuplicate(qrData)) return;
      if (isProcessing) return;
      isProcessing = true;

      updateStatus('scanning','Yoxlanƒ±lƒ±r...');

      try{
        // ‚úÖ H∆èR scan server…ô gedir -> sheet…ô d√º≈ü√ºr
        const res = await fetchJSONP(
          `${SHEET_API_URL}?action=scanTicket&qrData=${encodeURIComponent(qrData)}`,
          { timeoutMs: 12000, retry: 1 }
        );

        const name = res.data?.adSoyad || '-';
        const id = res.data?.empId || '-';
        const ticketType = res.data?.ticketType || (isDryQR(qrData) ? 'Quru Talon' : '-');
        const isDry = isDryQR(qrData) || String(ticketType).toLowerCase().includes('quru');

        // ‚úÖ QURU LOGƒ∞KA
        if (isDry){
          const c = getDryCount(qrData);

          // 3-c√º v…ô sonrasƒ± -> T…ôkrar c…ôhd (sheet…ô d…ô scanTicket il…ô d√º≈ü√ºr)
          if (c >= 2){
            updateStatus('warning','T…ôkrar c…ôhd');
            addScan({name, id, type:'Quru Talon', msg:'T…ôkrar c…ôhd', warn:true, err:false});
            showResult({resultType:'warning', name, id, type:'Quru Talon', statusText:'T…ôkrar c…ôhd', mode:'auto'});
            return;
          }

          // 2-ci scan -> confirm d√ºym…ôli ekran (sheet…ô T…ôsdiq yalnƒ±z d√ºym…ô basanda d√º≈ü…ôc…ôk)
          if (c === 1){
            // token haradan g…ôlirs…ô hamƒ±sƒ±nƒ± yoxlayƒ±rƒ±q
            const token =
              res.token ||
              res.confirmToken ||
              res.data?.token ||
              res.data?.confirmToken ||
              null;

            pendingConfirmQrData = qrData;
            pendingConfirmMeta = { name, id, type:'Quru Talon' };
            pendingConfirmToken = token;

            updateStatus('warning','T…ôsdiq');
            addScan({name, id, type:'Quru Talon', msg:'T…ôsdiq et (2-ci scan)', warn:true, err:false});

            showResult({
              resultType:'confirm',
              name, id,
              type:'Quru Talon',
              statusText:'‚úÖ T…ôsdiq et d√ºym…ôsin…ô basƒ±n',
              mode:'confirm',
              confirmToken: token
            });
            return;
          }

          // 1-ci scan -> normal g√∂st…ôr, sonra count=1 et
          setDryCount(qrData, 1);
        }

        // ‚úÖ NORMAL AXIN (v…ô quru 1-ci scan)
        if (res.status === 'success'){
          updateStatus('success', res.message || 'T…ôsdiql…ôndi');
          addScan({name, id, type: ticketType, msg: res.message || 'T…ôsdiql…ôndi', warn:false, err:false});
          showResult({resultType:'success', name, id, type: ticketType, statusText: res.message || 'T…ôsdiql…ôndi', mode:'auto'});
          return;
        }

        if (res.status === 'warning'){
          updateStatus('warning', res.message || 'X…ôb…ôrdarlƒ±q');
          addScan({name, id, type: ticketType, msg: res.message || 'X…ôb…ôrdarlƒ±q', warn:true, err:false});
          showResult({resultType:'warning', name, id, type: ticketType, statusText: res.message || 'X…ôb…ôrdarlƒ±q', mode:'auto'});
          return;
        }

        if (res.status === 'confirm'){
          // dig…ôr talonlar √º√ß√ºn backend confirm
          const token =
            res.token ||
            res.confirmToken ||
            res.data?.token ||
            res.data?.confirmToken ||
            null;

          pendingConfirmQrData = qrData;
          pendingConfirmMeta = { name, id, type: ticketType };
          pendingConfirmToken = token;

          addScan({name, id, type: ticketType, msg: res.message || 'T…ôsdiq t…ôl…ôb olunur', warn:true, err:false});
          showResult({
            resultType:'confirm',
            name, id, type: ticketType,
            statusText: res.message || 'T…ôsdiq t…ôl…ôb olunur',
            mode:'confirm',
            confirmToken: token
          });
          return;
        }

        updateStatus('error', res.message || 'X…ôta');
        addScan({name:'X…ôta', id:'-', type:'-', msg: res.message || 'X…ôta', err:true});
        showResult({resultType:'error', name:'X…ôta', id:'-', type:'-', statusText: res.message || 'X…ôta', mode:'auto'});

      }catch(e){
        updateStatus('error','Server…ô qo≈üulmadƒ±');
        addScan({name:'Baƒülantƒ± x…ôtasƒ±', id:'-', type:'-', msg:'Server…ô qo≈üulmadƒ±', err:true});
        showResult({resultType:'error', name:'Baƒülantƒ± x…ôtasƒ±', id:'-', type:'-', statusText:'Server…ô qo≈üulmadƒ±', mode:'auto'});
      }
    }

    // ‚úÖ 2-ci quru scan -> "T…ôsdiq et" d√ºym…ôsi
    document.getElementById('confirmBtn').onclick = async () => {
      const btn = document.getElementById('confirmBtn');
      if (!pendingConfirmQrData) return;

      btn.disabled = true;
      btn.textContent = 'G√∂nd…ôrilir...';

      const meta = pendingConfirmMeta || {name:'-', id:'-', type:'Quru Talon'};
      const qrData = pendingConfirmQrData;
      const token = pendingConfirmToken || '';

      try{
        // ‚úÖ IMPORTANT: cache olmasƒ±n dey…ô t=... …ôlav…ô edirik
        // ‚úÖ IMPORTANT: b…ôz…ôn backend tokeni "confirmToken" g√∂zl…ôyir, ona g√∂r…ô ikisini d…ô g√∂nd…ôririk
        const url =
          `${SHEET_API_URL}?action=confirmDrySecond` +
          `&token=${encodeURIComponent(token)}` +
          `&confirmToken=${encodeURIComponent(token)}` +
          `&qrData=${encodeURIComponent(qrData)}`;

        const res = await fetchJSONP(url, { timeoutMs: 12000, retry: 1 });

        // ‚úÖ burada sheet…ô d√º≈üm…ôsinin yegan…ô yolu: backend confirmDrySecond i√ßind…ô yazmalƒ±dƒ±r
        // biz user-…ô d√ºzg√ºn mesaj g√∂st…ôr…ôc…ôyik, amma server error verirs…ô d…ô g√∂st…ôr…ôc…ôyik
        if (res && (res.status === 'error' || res.status === 'failed')){
          updateStatus('error', res.message || 'T…ôsdiq alƒ±nmadƒ±');
          addScan({name: meta.name, id: meta.id, type: meta.type, msg: res.message || 'T…ôsdiq alƒ±nmadƒ±', err:true});
          showResult({resultType:'error', name: meta.name, id: meta.id, type: meta.type, statusText: res.message || 'T…ôsdiq alƒ±nmadƒ±', mode:'auto'});
          return;
        }

        // ‚úÖ 2-ci scan t…ôsdiql…ôndi -> count=2 (3-c√º scan ‚ÄúT…ôkrar c…ôhd‚Äù)
        setDryCount(qrData, 2);

        updateStatus('success','T…ôsdiq');
        addScan({
          name: res?.data?.adSoyad || meta.name,
          id: res?.data?.empId || meta.id,
          type: res?.data?.ticketType || meta.type,
          msg: res?.message || 'T…ôsdiq',
          warn:false, err:false
        });

        showResult({
          resultType:'success',
          name: res?.data?.adSoyad || meta.name,
          id: res?.data?.empId || meta.id,
          type: res?.data?.ticketType || meta.type,
          statusText: res?.message || 'T…ôsdiq ‚úÖ',
          mode:'auto'
        });

      }catch(e){
        updateStatus('error','T…ôsdiq g√∂nd…ôrilm…ôdi');
        addScan({name: meta.name, id: meta.id, type: meta.type, msg:'T…ôsdiq g√∂nd…ôrilm…ôdi', err:true});
        showResult({resultType:'error', name: meta.name, id: meta.id, type: meta.type, statusText:'T…ôsdiq g√∂nd…ôrilm…ôdi', mode:'auto'});
      }finally{
        btn.textContent = 'G√∂nd…ôrildi ‚úÖ';
      }
    };

    document.getElementById('closeBtn').onclick = () => {
      const closeBtn = document.getElementById('closeBtn');
      if (closeBtn.disabled) return;

      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
      hideResult();
    };

    function startCamera(){
      html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode:"environment" },
        { fps: 12, qrbox:{ width:250, height:250 }, disableFlip:true },
        (text)=>{ if (!isProcessing) handleScan(text); },
        ()=>{}
      ).catch(err=>{
        updateStatus('error','Kamera a√ßƒ±lmadƒ±!');
        console.error(err);
      });
    }

    window.onload = startCamera;
    window.onbeforeunload = ()=>{
      try{ if (html5QrCode) html5QrCode.stop(); }catch(e){}
      if (countdownInterval) clearInterval(countdownInterval);
    };
  </script>
</body>
</html>
