<!doctype html>
<html lang="az">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GHG Talon - Skan</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --muted:#8ea0c6;
      --text:#eaf0ff;
      --ok:#22c55e;
      --warn:#f59e0b;
      --err:#ef4444;
      --line:#223055;
      --btn:#2563eb;
      --btn2:#334155;
      --input:#0f1b33;
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #070b14, var(--bg));
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px;}
    .grid{display:grid;grid-template-columns: 1.1fr 0.9fr;gap:16px;}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr;} }
    .card{
      background: rgba(17,26,46,0.85);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      backdrop-filter: blur(6px);
    }
    h1{font-size:18px;margin:0 0 10px;}
    h2{font-size:14px;margin:0 0 10px;color:#cfe0ff}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted);font-size:12px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--line);border-radius:999px;
      padding:6px 10px;background: rgba(15,27,51,0.6);
      font-size:12px;color:#dce7ff;
    }
    .btn{
      border:0;border-radius:10px;
      padding:10px 12px;
      cursor:pointer;
      color:white;background:var(--btn);
      font-weight:600;
    }
    .btn.secondary{background:var(--btn2)}
    .input{
      background: rgba(15,27,51,0.9);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:10px;
      padding:10px 12px;
      outline:none;
      width:100%;
      box-sizing:border-box;
    }
    .statusBox{
      border:1px dashed var(--line);
      border-radius:12px;
      padding:12px;
      background: rgba(15,27,51,0.45);
    }
    .statusText{font-size:14px;font-weight:700;margin:0 0 6px;}
    .statusText.ok{color:var(--ok)}
    .statusText.warn{color:var(--warn)}
    .statusText.err{color:var(--err)}
    .tableWrap{overflow:auto;border:1px solid var(--line);border-radius:12px}
    table{width:100%;border-collapse:collapse;min-width:720px}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(34,48,85,0.6);font-size:13px}
    th{position:sticky;top:0;background:#0f1b33;color:#dbe6ff;text-align:left;z-index:1}
    tr:hover td{background: rgba(37,99,235,0.07)}
    .tag{
      font-size:12px;
      padding:4px 8px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,0.04);
      white-space:nowrap;
    }
    .tag.ok{border-color:rgba(34,197,94,0.45); color:#bff3cf}
    .tag.warn{border-color:rgba(245,158,11,0.5); color:#ffe3b0}
    .tag.err{border-color:rgba(239,68,68,0.45); color:#ffc3c3}
    .small{font-size:12px}
    .split{display:grid;grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width: 520px){ .split{grid-template-columns:1fr;} }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between;margin-bottom:12px;">
      <div>
        <h1>GHG Elektron Talon — Skan Paneli</h1>
        <div class="muted">Bugünkü skanlar avtomatik göstərilir və hər gün “0”dan başlayır (yalnız bugünkü tarix filtr olunur).</div>
      </div>
      <div class="row">
        <span class="pill"><span class="muted">Tarix:</span> <b id="todayLabel">-</b></span>
        <span class="pill"><span class="muted">Cəm skan:</span> <b id="totalLabel">0</b></span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Scan -->
      <div class="card">
        <h2>Skan</h2>

        <div class="split">
          <div>
            <label class="muted">QR Data (test üçün əl ilə də daxil edə bilərsiniz)</label>
            <input id="qrInput" class="input" placeholder="GHG|123|G|28.02.2026|HASH|lunch" />
          </div>
          <div>
            <label class="muted">Axtarış (Ad / ID)</label>
            <input id="searchInput" class="input" placeholder="Məs: Elvin / 1023" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" id="btnScan">Skan et</button>
          <button class="btn secondary" id="btnRefresh">Yenilə</button>
          <span class="muted small" id="hintApi">API: <span id="apiBase">Script URL tələb olunur</span></span>
        </div>

        <div style="margin-top:12px;" class="statusBox">
          <div id="statusText" class="statusText">Hazırdır</div>
          <div class="muted" id="statusDetail">Skan etdikcə aşağıdakı cədvəl bugünkü skanlara görə yenilənəcək.</div>

          <div id="confirmBox" style="display:none;margin-top:10px;">
            <div class="muted" style="margin-bottom:8px;">Quru talon 2-ci mərhələ təsdiqi tələb olunur.</div>
            <button class="btn" id="btnConfirmDry">Təsdiqlə</button>
            <button class="btn secondary" id="btnCancelConfirm">Ləğv et</button>
          </div>
        </div>
      </div>

      <!-- RIGHT: Today list -->
      <div class="card">
        <h2>Bugünkü skanlar</h2>
        <div class="muted" style="margin-bottom:10px;">
          Axtarış aktivdir. Siyahı yalnız <b>bugünkü tarix</b> üçün göstərilir.
        </div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th style="width:88px;">Saat</th>
                <th style="width:90px;">ID</th>
                <th>Ad Soyad</th>
                <th style="width:140px;">Talon</th>
                <th style="width:130px;">Status</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td colspan="5" class="muted">Məlumat yoxdur</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
/**
 * Vacib: Buraya Apps Script Web App URL-ni yazın.
 * Məsələn:
 * const SCRIPT_URL = "https://script.google.com/macros/s/AKfycb.../exec";
 */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz4mkQRCMUPzlYdJDeo-HMnLnLoe8a5LTCxoVQ_ooyr2TEEmk7Zn9yP5_zhBd7iix_S/exec"; // <-- bunu doldurun

let pendingDryToken = null;

function setStatus(type, title, detail){
  const el = document.getElementById('statusText');
  const det = document.getElementById('statusDetail');
  el.className = "statusText " + (type || "");
  el.textContent = title || "";
  det.textContent = detail || "";
}

function statusTagClass(statusText){
  const s = (statusText || "").toLowerCase();
  if (s.includes("təsdiqləndi")) return "ok";
  if (s.includes("təkrar")) return "warn";
  if (s.includes("xəta")) return "err";
  if (s.includes("təsdiq")) return "warn";
  return "";
}

function buildUrl(params){
  const u = new URL(SCRIPT_URL);
  Object.keys(params).forEach(k => u.searchParams.set(k, params[k]));
  return u.toString();
}

async function apiGet(params){
  if (!SCRIPT_URL){
    throw new Error("SCRIPT_URL boşdur. Skan.html daxilində Apps Script Web App URL-ni yazın.");
  }
  const res = await fetch(buildUrl(params), { method: "GET", cache: "no-store" });
  return await res.json();
}

function renderTable(items){
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  if (!items || !items.length){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="5" class="muted">Məlumat yoxdur</td>`;
    tbody.appendChild(tr);
    return;
  }

  for (const it of items){
    const tr = document.createElement("tr");
    const cls = statusTagClass(it.statusText);
    tr.innerHTML = `
      <td>${escapeHtml(it.time || "")}</td>
      <td>${escapeHtml(it.empId || "")}</td>
      <td>${escapeHtml(it.fullName || "")}</td>
      <td>${escapeHtml(it.ticketName || "")}</td>
      <td><span class="tag ${cls}">${escapeHtml(it.statusText || "")}</span></td>
    `;
    tbody.appendChild(tr);
  }
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

async function refreshTodayScans(){
  const q = document.getElementById("searchInput").value.trim();
  const data = await apiGet({ action: "getTodayScans", q });

  if (data.status !== "success"){
    setStatus("err", "Xəta", data.message || "Bugünkü skanlar oxunmadı");
    return;
  }

  document.getElementById("todayLabel").textContent = data.date || "-";
  document.getElementById("totalLabel").textContent = String(data.total ?? 0);
  renderTable(data.items || []);
}

async function scanNow(){
  const qrData = document.getElementById("qrInput").value.trim();
  if (!qrData){
    setStatus("warn", "Diqqət", "qrData boşdur");
    return;
  }

  setStatus("", "Yoxlanılır...", "Zəhmət olmasa gözləyin");
  pendingDryToken = null;
  document.getElementById("confirmBox").style.display = "none";

  const data = await apiGet({ action: "scanTicket", qrData });

  // nəticəni göstər
  if (data.status === "success"){
    setStatus("ok", data.message || "Təsdiqləndi", `${data.data?.adSoyad || ""} — ${data.data?.ticketType || ""}`);
  } else if (data.status === "warning"){
    setStatus("warn", data.message || "Xəbərdarlıq", `${data.data?.adSoyad || ""} — ${data.data?.ticketType || ""}`);
  } else if (data.status === "confirm"){
    pendingDryToken = data.token;
    setStatus("warn", data.message || "Təsdiq tələb olunur", `${data.data?.adSoyad || ""} — ${data.data?.ticketType || ""}`);
    document.getElementById("confirmBox").style.display = "block";
  } else {
    setStatus("err", "Xəta", data.message || "Skan zamanı xəta");
  }

  // hər skandan sonra bugünkü list yenilə
  await refreshTodayScans();
}

async function confirmDry(){
  if (!pendingDryToken){
    setStatus("warn", "Diqqət", "Təsdiq tokeni yoxdur");
    return;
  }
  setStatus("", "Təsdiqlənir...", "Zəhmət olmasa gözləyin");

  const data = await apiGet({ action: "confirmDrySecond", token: pendingDryToken });

  if (data.status === "success"){
    setStatus("ok", data.message || "Təsdiqləndi", `${data.data?.adSoyad || ""} — ${data.data?.ticketType || ""}`);
  } else if (data.status === "warning"){
    setStatus("warn", data.message || "Xəbərdarlıq", `${data.data?.adSoyad || ""} — ${data.data?.ticketType || ""}`);
  } else {
    setStatus("err", "Xəta", data.message || "Təsdiq zamanı xəta");
  }

  pendingDryToken = null;
  document.getElementById("confirmBox").style.display = "none";
  await refreshTodayScans();
}

function wire(){
  document.getElementById("apiBase").textContent = SCRIPT_URL ? "OK" : "SCRIPT_URL boşdur";
  document.getElementById("btnScan").addEventListener("click", scanNow);
  document.getElementById("btnRefresh").addEventListener("click", refreshTodayScans);

  document.getElementById("btnConfirmDry").addEventListener("click", confirmDry);
  document.getElementById("btnCancelConfirm").addEventListener("click", () => {
    pendingDryToken = null;
    document.getElementById("confirmBox").style.display = "none";
    setStatus("", "Ləğv edildi", "Quru talon təsdiqi ləğv olundu");
  });

  // search yazdıqca auto filter (debounce)
  let t = null;
  document.getElementById("searchInput").addEventListener("input", () => {
    if (t) clearTimeout(t);
    t = setTimeout(() => refreshTodayScans().catch(err => setStatus("err","Xəta",err.message)), 250);
  });

  // ilk açılışda siyahını çək
  refreshTodayScans().catch(err => setStatus("err","Xəta",err.message));

  // istəsəniz: hər 10 saniyədən bir avtomatik yenilə
  setInterval(() => {
    refreshTodayScans().catch(()=>{});
  }, 10000);
}

wire();
</script>
</body>
</html>
