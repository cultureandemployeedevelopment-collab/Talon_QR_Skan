<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GHG Yem…ôk Skaner</title>
    
    <!-- Html5Qrcode -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.4em;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .scanner-box {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        #reader {
            width: 100%;
            border-radius: 16px;
            overflow: hidden;
        }

        .status {
            text-align: center;
            padding: 15px;
            margin-top: 15px;
            border-radius: 12px;
            font-weight: 600;
        }

        .status-waiting { background: #fff3e0; color: #e65100; }
        .status-success { background: #e8f5e9; color: #2e7d32; }
        .status-warning { background: #fff3e0; color: #f57c00; }
        .status-error { background: #ffebee; color: #c62828; }

        .last-scan {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .last-scan h2 {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 15px;
        }

        .scan-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .scan-item:last-child { border-bottom: none; }

        .scan-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 15px;
        }

        .scan-icon.ok { background: #e8f5e9; color: #4caf50; }
        .scan-icon.warn { background: #fff3e0; color: #ff9800; }
        .scan-icon.err { background: #ffebee; color: #f44336; }

        .scan-info { flex: 1; }

        .scan-name {
            font-weight: 600;
            color: #333;
            font-size: 1.05em;
        }

        .scan-detail {
            color: #666;
            font-size: 0.85em;
            margin-top: 3px;
        }

        .scan-time {
            color: #999;
            font-size: 0.75em;
            margin-top: 3px;
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>üçΩÔ∏è GHG Yem…ôk Skaner</h1>
    </div>

    <div class="container">
        <div class="scanner-box">
            <div id="reader"></div>
            <div class="status status-waiting" id="status">
                QR kod g√∂zl…ônilir...
            </div>
        </div>

        <div class="last-scan">
            <h2>üìã Son skan edil…ônl…ôr</h2>
            <div id="scanList">
                <div style="text-align: center; color: #999; padding: 20px;">
                    H…ôl…ô he√ß bir skan edilm…ôyib
                </div>
            </div>
        </div>
    </div>

    <script>
        // WEB APP URL-Nƒ∞Zƒ∞ BURAYA YAZIN
        const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbzmVCJwPPZ2ACEQyqOwKsVf42nEqVGy0MAMRyNQ99TIwzhmDBSkuxoE3OvW1ZB5Qp_L/exec';
        
        let isProcessing = false;
        let scanHistory = [];
        let html5QrCode = null;

        // JSONP fetch
        function fetchJSONP(url) {
            return new Promise((resolve, reject) => {
                const cb = 'cb_' + Date.now();
                const script = document.createElement('script');
                
                window[cb] = (data) => {
                    delete window[cb];
                    script.remove();
                    resolve(data);
                };
                
                setTimeout(() => {
                    delete window[cb];
                    script.remove();
                    reject(new Error('Timeout'));
                }, 10000);
                
                script.src = url + '&callback=' + cb;
                document.head.appendChild(script);
            });
        }

        // Skan emalƒ±
        async function handleScan(qrData) {
            if (isProcessing) return;
            isProcessing = true;
            
            updateStatus('scanning', 'G√∂nd…ôrilir...');
            
            try {
                const result = await fetchJSONP(
                    SHEET_API_URL + '?action=scanTicket&qrData=' + encodeURIComponent(qrData)
                );
                
                console.log('N…ôtic…ô:', result);
                
                if (result.status === 'success') {
                    addScan({
                        ok: true,
                        name: result.data.adSoyad,
                        id: result.data.empId,
                        type: result.data.ticketType,
                        msg: 'T…ôsdiql…ôndi'
                    });
                    updateStatus('success', result.data.adSoyad + ' - T…ôsdiql…ôndi');
                    
                } else if (result.status === 'warning') {
                    addScan({
                        ok: false,
                        warn: true,
                        name: result.data.adSoyad,
                        id: result.data.empId,
                        type: result.data.ticketType,
                        msg: 'Artƒ±q istifad…ô edilib'
                    });
                    updateStatus('warning', result.data.adSoyad + ' - Artƒ±q istifad…ô edilib');
                    
                } else {
                    addScan({
                        ok: false,
                        name: 'X…ôta',
                        id: '-',
                        msg: result.message || 'X…ôta'
                    });
                    updateStatus('error', result.message || 'X…ôta');
                }
                
            } catch (e) {
                console.error(e);
                addScan({
                    ok: false,
                    name: 'Baƒülantƒ± x…ôtasƒ±',
                    id: '-',
                    msg: 'Server…ô qo≈üulmadƒ±'
                });
                updateStatus('error', 'Baƒülantƒ± x…ôtasƒ±!');
            }
            
            setTimeout(() => {
                isProcessing = false;
                updateStatus('waiting', 'QR kod g√∂zl…ônilir...');
            }, 2000);
        }

        function updateStatus(type, text) {
            const s = document.getElementById('status');
            s.className = 'status status-' + type;
            s.textContent = text;
        }

        function addScan(data) {
            const time = new Date().toLocaleTimeString('az-AZ');
            scanHistory.unshift({...data, time});
            if (scanHistory.length > 10) scanHistory.pop();
            
            const list = document.getElementById('scanList');
            list.innerHTML = scanHistory.map(item => {
                let icon, cls;
                if (item.ok) { icon = '‚úì'; cls = 'ok'; }
                else if (item.warn) { icon = '‚ö†'; cls = 'warn'; }
                else { icon = '‚úï'; cls = 'err'; }
                
                return `
                    <div class="scan-item">
                        <div class="scan-icon ${cls}">${icon}</div>
                        <div class="scan-info">
                            <div class="scan-name">${item.name}</div>
                            <div class="scan-detail">${item.id} ${item.type ? '| ' + item.type : ''} | ${item.msg}</div>
                            <div class="scan-time">${item.time}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Kamera ba≈ülat
        function startCamera() {
            html5QrCode = new Html5Qrcode("reader");
            
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (text) => {
                    if (!isProcessing) handleScan(text);
                },
                () => {}
            ).catch(err => {
                updateStatus('error', 'Kamera a√ßƒ±lmadƒ±!');
                console.error(err);
            });
        }

        window.onload = startCamera;
        
        window.onbeforeunload = () => {
            if (html5QrCode) html5QrCode.stop();
        };
    </script>
</body>
</html>

