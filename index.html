<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>GHG Yem…ôk Skaner</title>

  <!-- Html5Qrcode -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:#f0f2f5;min-height:100vh
    }
    .header{
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:#fff;padding:15px;text-align:center
    }
    .header h1{font-size:1.3em}
    .container{max-width:600px;margin:0 auto;padding:15px}

    .scanner-box{
      background:#fff;border-radius:20px;padding:15px;margin-bottom:15px;
      box-shadow:0 4px 15px rgba(0,0,0,.1)
    }
    #reader{width:100%;border-radius:16px;overflow:hidden}

    .status{
      text-align:center;padding:12px;margin-top:10px;border-radius:12px;
      font-weight:600;font-size:.95em
    }
    .status-waiting{background:#fff3e0;color:#e65100}
    .status-scanning{background:#e3f2fd;color:#1565c0}
    .status-success{background:#e8f5e9;color:#2e7d32}
    .status-warning{background:#fff3e0;color:#f57c00}
    .status-error{background:#ffebee;color:#c62828}

    .result-overlay{
      display:none;position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,.85);z-index:1000;justify-content:center;align-items:center;
      padding:20px
    }
    .result-card{
      background:#fff;border-radius:24px;padding:26px;width:100%;max-width:420px;
      text-align:center;animation:slideIn .3s ease
    }
    @keyframes slideIn{from{transform:translateY(-50px);opacity:0}to{transform:translateY(0);opacity:1}}
    .result-icon{
      width:100px;height:100px;border-radius:50%;margin:0 auto 16px;
      display:flex;align-items:center;justify-content:center;font-size:50px
    }
    .result-success .result-icon{background:#e8f5e9;color:#4caf50}
    .result-warning .result-icon{background:#fff3e0;color:#ff9800}
    .result-error .result-icon{background:#ffebee;color:#f44336}
    .result-confirm .result-icon{background:#e3f2fd;color:#1565c0}

    .result-title{font-size:1.5em;font-weight:700;margin-bottom:14px}
    .result-success .result-title{color:#2e7d32}
    .result-warning .result-title{color:#f57c00}
    .result-error .result-title{color:#c62828}
    .result-confirm .result-title{color:#1565c0}

    .result-details{
      background:#f5f5f5;border-radius:16px;padding:18px;margin-bottom:14px;text-align:left
    }
    .detail-row{display:flex;justify-content:space-between;padding:9px 0;border-bottom:1px solid #e0e0e0}
    .detail-row:last-child{border-bottom:none}
    .detail-label{color:#666;font-size:.9em}
    .detail-value{color:#333;font-weight:600;font-size:.95em}

    .countdown{font-size:2.5em;font-weight:700;color:#667eea;margin-top:10px}
    .countdown-text{color:#999;font-size:.9em;margin-top:5px}

    #confirmBtn{
      display:none;
      width:100%;
      padding:12px 14px;
      border:none;
      border-radius:12px;
      font-weight:800;
      cursor:pointer;
      margin-top:12px;
      background:linear-gradient(135deg,#0f2a55,#1f55d9);
      color:#fff;
    }
    #confirmBtn:disabled{opacity:.7;cursor:not-allowed}

    .last-scan{
      background:#fff;border-radius:20px;padding:20px;
      box-shadow:0 4px 15px rgba(0,0,0,.1)
    }
    .last-scan h2{font-size:1.1em;color:#333;margin-bottom:15px}
    .scan-item{display:flex;align-items:center;padding:12px;border-bottom:1px solid #eee}
    .scan-item:last-child{border-bottom:none}
    .scan-icon{
      width:40px;height:40px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;font-size:18px;margin-right:12px;flex-shrink:0
    }
    .scan-icon.ok{background:#e8f5e9;color:#4caf50}
    .scan-icon.warn{background:#fff3e0;color:#ff9800}
    .scan-icon.err{background:#ffebee;color:#f44336}
    .scan-info{flex:1;min-width:0}
    .scan-name{font-weight:600;color:#333;font-size:.95em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .scan-detail{color:#666;font-size:.8em;margin-top:2px}
    .scan-time{color:#999;font-size:.75em;margin-top:2px}
  </style>
</head>

<body>
  <div class="header">
    <h1>üçΩÔ∏è GHG Yem…ôk Skaner</h1>
  </div>

  <div class="container">
    <div class="scanner-box">
      <div id="reader"></div>
      <div class="status status-waiting" id="status">QR kod g√∂zl…ônilir...</div>
    </div>

    <div class="last-scan">
      <h2>üìã Son skan edil…ônl…ôr</h2>
      <div id="scanList">
        <div style="text-align:center;color:#999;padding:20px;">H…ôl…ô he√ß bir skan edilm…ôyib</div>
      </div>
    </div>
  </div>

  <!-- Result overlay -->
  <div class="result-overlay" id="resultOverlay">
    <div class="result-card" id="resultCard">
      <div class="result-icon" id="resultIcon">‚úì</div>
      <div class="result-title" id="resultTitle">T…ôsdiql…ôndi</div>

      <div class="result-details" id="resultDetails">
        <div class="detail-row">
          <span class="detail-label">∆èm…ôkda≈ü:</span>
          <span class="detail-value" id="detailName">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">ID:</span>
          <span class="detail-value" id="detailId">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Talon:</span>
          <span class="detail-value" id="detailTicket">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Status:</span>
          <span class="detail-value" id="detailStatus">-</span>
        </div>
      </div>

      <button id="confirmBtn">Quru talonu T∆èSDƒ∞QL∆è</button>

      <div class="countdown" id="countdown">10</div>
      <div class="countdown-text" id="countdownText">saniy…ô sonra skaner…ô qayƒ±dƒ±lƒ±r</div>
    </div>
  </div>

  <script>
    // ‚úÖ BURAYA APPS SCRIPT WEB APP URL YAZILIR (Deploy ed…ônd…ôn sonra alƒ±nƒ±r)
    const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbyi9jq6gW2jIKIWGkB5rCEC9t11IPRudequaq-QMoTlfmaq7jhBTP-pysPJ9UZxJpeV/exec';

    let isProcessing = false;
    let scanHistory = [];
    let html5QrCode = null;
    let countdownInterval = null;

    let audioContext = null;
    function ensureAudioContext() {
      if (!audioContext) {
        const Ctx = window.AudioContext || window.webkitAudioContext;
        if (!Ctx) return null;
        audioContext = new Ctx();
      }
      if (audioContext.state === 'suspended') audioContext.resume().catch(() => {});
      return audioContext;
    }
    function playTone(frequency, duration, startAt, volume = 0.22) {
      const ctx = ensureAudioContext(); if (!ctx) return;
      const oscillator = ctx.createOscillator();
      const gain = ctx.createGain();
      oscillator.type = 'sine';
      oscillator.frequency.setValueAtTime(frequency, startAt);
      gain.gain.setValueAtTime(0, startAt);
      gain.gain.linearRampToValueAtTime(volume, startAt + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.001, startAt + duration);
      oscillator.connect(gain);
      gain.connect(ctx.destination);
      oscillator.start(startAt);
      oscillator.stop(startAt + duration);
    }
    function playFeedbackSound(resultType) {
      const ctx = ensureAudioContext(); if (!ctx) return;
      const now = ctx.currentTime;
      if (resultType === 'success') {
        playTone(880, 0.18, now, 0.24);
        playTone(1175, 0.25, now + 0.2, 0.24);
      } else if (resultType === 'warning') {
        playTone(520, 0.22, now, 0.24);
        playTone(420, 0.28, now + 0.24, 0.24);
      } else if (resultType === 'confirm') {
        playTone(660, 0.20, now, 0.22);
        playTone(660, 0.20, now + 0.25, 0.22);
      } else {
        playTone(350, 0.5, now, 0.5);
        playTone(300, 0.45, now + 0.22, 0.5);
      }
    }

    // ‚úÖ JSONP fetch (t…ôk d…ôf…ô)
    function fetchJSONP(url) {
      return new Promise((resolve, reject) => {
        const cb = 'cb_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
        const script = document.createElement('script');

        window[cb] = (data) => {
          delete window[cb];
          script.remove();
          resolve(data);
        };

        const t = setTimeout(() => {
          if (window[cb]) delete window[cb];
          script.remove();
          reject(new Error('Timeout'));
        }, 12000);

        script.onload = () => clearTimeout(t);
        script.onerror = () => { clearTimeout(t); reject(new Error('Load error')); };

        script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
        document.head.appendChild(script);
      });
    }

    function updateStatus(type, text) {
      const s = document.getElementById('status');
      s.className = 'status status-' + type;
      s.textContent = text;
    }

    function addScan(item) {
      const time = new Date().toLocaleTimeString('az-AZ');
      scanHistory.unshift({ ...item, time });
      if (scanHistory.length > 10) scanHistory.pop();

      const list = document.getElementById('scanList');
      list.innerHTML = scanHistory.map(scan => {
        let icon, cls;
        if (scan.ok) { icon = '‚úì'; cls = 'ok'; }
        else if (scan.warn) { icon = '‚ö†'; cls = 'warn'; }
        else { icon = '‚úï'; cls = 'err'; }

        return `
          <div class="scan-item">
            <div class="scan-icon ${cls}">${icon}</div>
            <div class="scan-info">
              <div class="scan-name">${scan.name}</div>
              <div class="scan-detail">${scan.id} ${scan.type ? '| ' + scan.type : ''} | ${scan.msg}</div>
              <div class="scan-time">${scan.time}</div>
            </div>
          </div>`;
      }).join('');
    }

    function hideResult() {
      document.getElementById('resultOverlay').style.display = 'none';
      isProcessing = false;
      updateStatus('waiting', 'QR kod g√∂zl…ônilir...');
    }

    function showResult(data) {
      const overlay = document.getElementById('resultOverlay');
      const card = document.getElementById('resultCard');
      const icon = document.getElementById('resultIcon');
      const title = document.getElementById('resultTitle');
      const countdownEl = document.getElementById('countdown');
      const countdownText = document.getElementById('countdownText');
      const confirmBtn = document.getElementById('confirmBtn');

      // reset confirm
      confirmBtn.style.display = 'none';
      confirmBtn.disabled = false;
      confirmBtn.onclick = null;

      // fill details
      document.getElementById('detailName').textContent = data.name || '-';
      document.getElementById('detailId').textContent = data.id || '-';
      document.getElementById('detailTicket').textContent = data.type || '-';
      document.getElementById('detailStatus').textContent = data.statusText || '-';

      card.className = 'result-card result-' + data.resultType;

      if (data.resultType === 'success') {
        icon.textContent = '‚úì'; title.textContent = 'T…ôsdiql…ôndi';
      } else if (data.resultType === 'warning') {
        icon.textContent = '‚ö†'; title.textContent = 'X…ôb…ôrdarlƒ±q';
      } else if (data.resultType === 'confirm') {
        icon.textContent = '?'; title.textContent = 'T…ôsdiq t…ôl…ôb olunur';
      } else {
        icon.textContent = '‚úï'; title.textContent = 'X…ôta';
      }

      playFeedbackSound(data.resultType);

      overlay.style.display = 'flex';

      // CONFIRM mode (quru 2-ci d…ôf…ô)
      if (data.resultType === 'confirm') {
        if (countdownInterval) clearInterval(countdownInterval);
        countdownEl.textContent = '-';
        countdownText.textContent = 'T…ôsdiql…ôyin v…ô ya ekrana klikl…ô baƒülayƒ±n';

        confirmBtn.style.display = 'block';
        confirmBtn.textContent = 'Quru talonu T∆èSDƒ∞QL∆è';

        confirmBtn.onclick = async () => {
          confirmBtn.disabled = true;
          confirmBtn.textContent = 'G√∂nd…ôrilir...';
          try {
            const res = await fetchJSONP(
              SHEET_API_URL + '?action=confirmDrySecond&token=' + encodeURIComponent(data.token)
            );

            if (res.status === 'success') {
              addScan({
                ok: true,
                name: res.data.adSoyad,
                id: res.data.empId,
                type: res.data.ticketType,
                msg: res.message || 'T…ôsdiql…ôndi'
              });

              showResult({
                resultType: 'success',
                name: res.data.adSoyad,
                id: res.data.empId,
                type: res.data.ticketType,
                statusText: res.message || 'T…ôsdiql…ôndi'
              });
            } else {
              addScan({
                ok: false,
                warn: true,
                name: (res.data && res.data.adSoyad) ? res.data.adSoyad : 'X…ôb…ôrdarlƒ±q',
                id: (res.data && res.data.empId) ? res.data.empId : '-',
                type: (res.data && res.data.ticketType) ? res.data.ticketType : '',
                msg: res.message || 'T…ôsdiql…ônm…ôdi'
              });

              showResult({
                resultType: 'warning',
                name: (res.data && res.data.adSoyad) ? res.data.adSoyad : '-',
                id: (res.data && res.data.empId) ? res.data.empId : '-',
                type: (res.data && res.data.ticketType) ? res.data.ticketType : '-',
                statusText: res.message || 'T…ôsdiql…ônm…ôdi'
              });
            }
          } catch (e) {
            showResult({ resultType: 'error', name: 'X…ôta', id: '-', type: '-', statusText: 'Server x…ôtasƒ±' });
          }
        };

        overlay.onclick = function (e) {
          if (e.target === overlay) hideResult();
        };
        return;
      }

      // NORMAL mode: 10 saniy…ô countdown
      let seconds = 10;
      countdownEl.textContent = seconds;
      countdownText.textContent = 'saniy…ô sonra skaner…ô qayƒ±dƒ±lƒ±r';

      if (countdownInterval) clearInterval(countdownInterval);
      countdownInterval = setInterval(() => {
        seconds--;
        countdownEl.textContent = seconds;
        if (seconds <= 0) {
          clearInterval(countdownInterval);
          hideResult();
        }
      }, 1000);

      overlay.onclick = function (e) {
        if (e.target === overlay) {
          clearInterval(countdownInterval);
          hideResult();
        }
      };
    }

    async function handleScan(qrData) {
      if (isProcessing) return;
      isProcessing = true;
      updateStatus('scanning', 'Yoxlanƒ±lƒ±r...');

      try {
        const result = await fetchJSONP(
          SHEET_API_URL + '?action=scanTicket&qrData=' + encodeURIComponent(qrData)
        );

        // ‚úÖ QURU 2-ci d…ôf…ô: confirm
        if (result.status === 'confirm') {
          showResult({
            resultType: 'confirm',
            token: result.token,
            name: result.data.adSoyad,
            id: result.data.empId,
            type: result.data.ticketType,
            statusText: result.message || 'T…ôsdiq t…ôl…ôb olunur'
          });
          return;
        }

        if (result.status === 'success') {
          addScan({
            ok: true,
            name: result.data.adSoyad,
            id: result.data.empId,
            type: result.data.ticketType,
            msg: result.message || 'T…ôsdiql…ôndi'
          });

          showResult({
            resultType: 'success',
            name: result.data.adSoyad,
            id: result.data.empId,
            type: result.data.ticketType,
            statusText: result.message || 'T…ôsdiql…ôndi'
          });

        } else if (result.status === 'warning') {
          addScan({
            ok: false,
            warn: true,
            name: result.data.adSoyad,
            id: result.data.empId,
            type: result.data.ticketType,
            msg: result.message || 'T…ôkrar c…ôhd'
          });

          showResult({
            resultType: 'warning',
            name: result.data.adSoyad,
            id: result.data.empId,
            type: result.data.ticketType,
            statusText: result.message || 'T…ôkrar c…ôhd'
          });

        } else {
          addScan({ ok: false, name: 'X…ôta', id: '-', msg: result.message || 'Yanlƒ±≈ü QR kod' });

          showResult({
            resultType: 'error',
            name: 'X…ôta',
            id: '-',
            type: '-',
            statusText: result.message || 'Yanlƒ±≈ü QR kod'
          });
        }
      } catch (e) {
        addScan({ ok: false, name: 'Baƒülantƒ± x…ôtasƒ±', id: '-', msg: 'Server…ô qo≈üulmadƒ±' });

        showResult({
          resultType: 'error',
          name: 'Baƒülantƒ± x…ôtasƒ±',
          id: '-',
          type: '-',
          statusText: 'Server…ô qo≈üulmadƒ±'
        });
      }
    }

    function startCamera() {
      html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        (text) => { if (!isProcessing) handleScan(text); },
        () => {}
      ).catch(err => {
        updateStatus('error', 'Kamera a√ßƒ±lmadƒ±!');
        console.error(err);
      });
    }

    window.onload = startCamera;
    window.onbeforeunload = () => {
      if (html5QrCode) html5QrCode.stop();
      if (countdownInterval) clearInterval(countdownInterval);
    };
  </script>
</body>
</html>
